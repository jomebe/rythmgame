<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¦¬ë“¬í•œê¸€ - í•œê¸€ íƒ€ì´í•‘ ë¦¬ë“¬ê²Œì„</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Nanum Gothic', sans-serif;
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            color: white;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            overflow: hidden;
        }
        
        #game-container {
            width: 800px;
            height: 600px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 15px;
            position: relative;
            box-shadow: 0 0 20px rgba(0, 0, 255, 0.5);
            overflow: hidden;
        }
        
        #title {
            text-align: center;
            color: #fff;
            font-size: 36px;
            text-shadow: 0 0 10px #00f, 0 0 20px #00f;
            margin-bottom: 20px;
        }
        
        #score-display {
            position: absolute;
            top: 10px;
            right: 20px;
            font-size: 24px;
            color: #fff;
        }
        
        #combo-display {
            position: absolute;
            top: 40px;
            right: 20px;
            font-size: 20px;
            color: #ffcc00;
        }
        
        #accuracy-display {
            position: absolute;
            top: 70px;
            right: 20px;
            font-size: 18px;
            color: #33ff33;
        }
        
        #word-display {
            position: absolute;
            top: 120px;
            left: 0;
            width: 100%;
            text-align: center;
            font-size: 48px;
            color: #fff;
            text-shadow: 0 0 15px rgba(255, 255, 255, 0.5);
        }
        
        #current-jamo {
            position: absolute;
            top: 230px;
            left: 0;
            width: 100%;
            text-align: center;
            font-size: 72px;
            color: #ff33cc;
            text-shadow: 0 0 20px rgba(255, 51, 204, 0.8);
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        #typed-so-far {
            position: absolute;
            top: 330px;
            left: 0;
            width: 100%;
            text-align: center;
            font-size: 32px;
            color: #33ccff;
        }
        
        #beat-indicator {
            position: absolute;
            bottom: 180px;
            left: 50%;
            transform: translateX(-50%);
            width: 400px;
            height: 5px;
            background: rgba(255, 255, 255, 0.3);
        }
        
        #beat-marker {
            position: absolute;
            top: 0;
            left: 0;
            width: 10px;
            height: 5px;
            background: #fff;
            border-radius: 50%;
            box-shadow: 0 0 10px #fff;
        }
        
        #keyboard-guide {
            position: absolute;
            bottom: 20px;
            left: 0;
            width: 100%;
            text-align: center;
            font-size: 20px;
            color: rgba(255, 255, 255, 0.7);
        }
        
        #judgment {
            position: absolute;
            top: 400px;
            left: 0;
            width: 100%;
            text-align: center;
            font-size: 36px;
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        #judgment.perfect {
            color: #00ffff;
            text-shadow: 0 0 10px #00ffff;
        }
        
        #judgment.great {
            color: #33ff33;
            text-shadow: 0 0 10px #33ff33;
        }
        
        #judgment.good {
            color: #ffcc00;
            text-shadow: 0 0 10px #ffcc00;
        }
        
        #judgment.miss {
            color: #ff3333;
            text-shadow: 0 0 10px #ff3333;
        }
        
        #start-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10;
        }
        
        #result-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10;
        }
        
        .button {
            background: linear-gradient(45deg, #3498db, #9b59b6);
            border: none;
            padding: 12px 30px;
            color: white;
            font-size: 24px;
            border-radius: 50px;
            cursor: pointer;
            margin-top: 20px;
            transition: all 0.3s;
            box-shadow: 0 0 15px rgba(52, 152, 219, 0.5);
        }
        
        .button:hover {
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(155, 89, 182, 0.7);
        }
        
        .result-stat {
            margin: 10px 0;
            font-size: 24px;
        }
        
        .combo-effect {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 60px;
            opacity: 0;
            transition: all 0.5s;
            color: #ffcc00;
            text-shadow: 0 0 15px rgba(255, 204, 0, 0.8);
            z-index: 5;
        }
        
        .beat-flash {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.1);
            opacity: 0;
            pointer-events: none;
        }
        
        #virtual-keyboard {
            position: absolute;
            bottom: 60px;
            left: 50%;
            transform: translateX(-50%);
            width: 80%;
            display: flex;
            flex-direction: column;
            gap: 5px;
            background: rgba(0, 0, 0, 0.5);
            padding: 10px;
            border-radius: 10px;
            display: none;
        }
        
        .key-row {
            display: flex;
            justify-content: center;
            gap: 5px;
        }
        
        .key {
            width: 40px;
            height: 40px;
            background: rgba(80, 80, 100, 0.7);
            border: 1px solid #666;
            border-radius: 5px;
            color: white;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.1s;
        }
        
        .key:hover {
            background: rgba(100, 100, 140, 0.9);
        }
        
        .key.active {
            background: rgba(255, 100, 255, 0.9);
            transform: scale(1.1);
        }
        
        #music-settings {
            background: rgba(0, 0, 0, 0.4);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            width: 80%;
            max-width: 500px;
        }
        
        .music-input {
            margin: 10px 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .music-input label {
            margin-right: 10px;
            color: #33ccff;
        }
        
        .music-input input[type="number"] {
            width: 80px;
            padding: 5px;
            border-radius: 5px;
            border: none;
            background: rgba(80, 80, 100, 0.7);
            color: white;
            text-align: center;
        }
        
        .music-input input[type="file"] {
            background: rgba(80, 80, 100, 0.7);
            border-radius: 5px;
            padding: 5px;
            color: white;
        }
        
        #music-controls {
            position: absolute;
            top: 10px;
            left: 20px;
            display: flex;
            align-items: center;
        }
        
        #music-controls .music-name {
            margin-left: 10px;
            font-size: 16px;
            opacity: 0.8;
        }
        
        .toggle-switch {
            position: relative;
            width: 50px;
            height: 24px;
            display: inline-block;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(80, 80, 100, 0.7);
            transition: .4s;
            border-radius: 24px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .toggle-slider {
            background-color: #33ccff;
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }
        
        .detected-bpm {
            margin-top: 10px;
            font-size: 16px;
            color: #33ff33;
        }
        
        .detected-bpm span {
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1 id="title">ë¦¬ë“¬í•œê¸€</h1>
    
    <div id="game-container">
        <div id="score-display">ì ìˆ˜: 0</div>
        <div id="combo-display">ì½¤ë³´: 0</div>
        <div id="accuracy-display">ì •í™•ë„: 0%</div>
        
        <div id="word-display"></div>
        <div id="current-jamo"></div>
        <div id="typed-so-far"></div>
        
        <div id="beat-indicator">
            <div id="beat-marker"></div>
        </div>
        
        <div id="judgment"></div>
        
        <div id="keyboard-guide">
            ã„±ã„´ã„·ã„¹ã…ã…‚ã……ã…‡ã…ˆã…Šã…‹ã…Œã…ã… | ã…ã…‘ã…“ã…•ã…—ã…›ã…œã… ã…¡ã…£ | ã„²ã„¸ã…ƒã…†ã…‰...
        </div>
        
        <div class="beat-flash"></div>
        
        <div id="start-screen">
            <h2>ë¦¬ë“¬í•œê¸€ì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤!</h2>
            <p>ë°•ìì— ë§ì¶° í•œê¸€ ìëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”.</p>
            <p>ë‹¨ì–´ ì™„ì„± ì‹œ ë‹¤ìŒ ë‹¨ì–´ë¡œ ë„˜ì–´ê°‘ë‹ˆë‹¤.</p>
            <p style="color: #ff9900;">â€» í•œ/ì˜ í‚¤ë¥¼ ëˆŒëŸ¬ í•œê¸€ ì…ë ¥ ëª¨ë“œë¡œ ì „í™˜í•˜ì„¸ìš”!</p>
            
            <div id="music-settings">
                <h3>ë…¸ë˜ ì„¤ì •</h3>
                <div class="music-input">
                    <label for="music-file">ë…¸ë˜ ì„ íƒ:</label>
                    <input type="file" id="music-file" accept="audio/*">
                </div>
                <div class="music-input">
                    <label for="bpm-auto">BPM ìë™ ê°ì§€:</label>
                    <div class="toggle-switch">
                        <input type="checkbox" id="bpm-auto" checked>
                        <span class="toggle-slider"></span>
                    </div>
                </div>
                <div class="music-input" id="manual-bpm-container">
                    <label for="bpm-input">ìˆ˜ë™ BPM ì„¤ì •:</label>
                    <input type="number" id="bpm-input" min="60" max="300" value="140">
                </div>
                <div id="detected-bpm" class="detected-bpm">
                    ê°ì§€ëœ BPM: <span>-</span>
                </div>
            </div>
            
            <button id="start-button" class="button">ê²Œì„ ì‹œì‘</button>
        </div>
        
        <div id="result-screen">
            <h2>ê²Œì„ ê²°ê³¼</h2>
            <div class="result-stat" id="final-score">ìµœì¢… ì ìˆ˜: 0</div>
            <div class="result-stat" id="max-combo">ìµœëŒ€ ì½¤ë³´: 0</div>
            <div class="result-stat" id="final-accuracy">ìµœì¢… ì •í™•ë„: 0%</div>
            <div class="result-stat" id="words-completed">ì™„ì„±í•œ ë‹¨ì–´: 0</div>
            <button id="restart-button" class="button">ë‹¤ì‹œ ì‹œì‘</button>
        </div>
        
        <div id="virtual-keyboard">
            <div class="key-row">
                <button class="key" data-key="ã„±">ã„±</button>
                <button class="key" data-key="ã„´">ã„´</button>
                <button class="key" data-key="ã„·">ã„·</button>
                <button class="key" data-key="ã„¹">ã„¹</button>
                <button class="key" data-key="ã…">ã…</button>
                <button class="key" data-key="ã…‚">ã…‚</button>
                <button class="key" data-key="ã……">ã……</button>
            </div>
            <div class="key-row">
                <button class="key" data-key="ã…‡">ã…‡</button>
                <button class="key" data-key="ã…ˆ">ã…ˆ</button>
                <button class="key" data-key="ã…Š">ã…Š</button>
                <button class="key" data-key="ã…‹">ã…‹</button>
                <button class="key" data-key="ã…Œ">ã…Œ</button>
                <button class="key" data-key="ã…">ã…</button>
                <button class="key" data-key="ã…">ã…</button>
            </div>
            <div class="key-row">
                <button class="key" data-key="ã„²">ã„²</button>
                <button class="key" data-key="ã„¸">ã„¸</button>
                <button class="key" data-key="ã…ƒ">ã…ƒ</button>
                <button class="key" data-key="ã…†">ã…†</button>
                <button class="key" data-key="ã…‰">ã…‰</button>
            </div>
            <div class="key-row">
                <button class="key" data-key="ã…">ã…</button>
                <button class="key" data-key="ã…‘">ã…‘</button>
                <button class="key" data-key="ã…“">ã…“</button>
                <button class="key" data-key="ã…•">ã…•</button>
                <button class="key" data-key="ã…—">ã…—</button>
                <button class="key" data-key="ã…›">ã…›</button>
                <button class="key" data-key="ã…œ">ã…œ</button>
            </div>
            <div class="key-row">
                <button class="key" data-key="ã… ">ã… </button>
                <button class="key" data-key="ã…¡">ã…¡</button>
                <button class="key" data-key="ã…£">ã…£</button>
                <button class="key" data-key="ã…">ã…</button>
                <button class="key" data-key="ã…”">ã…”</button>
            </div>
        </div>
    </div>
    
    <script>
        // ê²Œì„ ì„¤ì • ë° ë³€ìˆ˜
        const words = [
            "ì•ˆë…•í•˜ì„¸ìš”", "ë¦¬ë“¬ê²Œì„", "í•œê¸€íƒ€ì´í•‘", "ì‹ ë‚˜ëŠ”", "ë°•ìê°ê°", 
            "ì½”ë”©ì¬ë¯¸", "ìŒì•…ê²Œì„", "ë„ì „í•´ìš”", "ì„±ê³µí–ˆì–´", "ììŒëª¨ìŒ", 
            "í™”ì´íŒ…", "ë…¸ë˜ë“£ê¸°", "ë¬¸ì¥ì™„ì„±", "ë‹¨ì–´ë†€ì´", "ìµœê³ ì ìˆ˜"
        ];
        
        let currentWord = "";
        let currentJamo = "";
        let typedSoFar = "";
        let targetJamoIndex = 0;
        let wordIndex = 0;
        let decomposedWord = [];
        
        let score = 0;
        let combo = 0;
        let maxCombo = 0;
        let correctHits = 0;
        let totalHits = 0;
        let wordsCompleted = 0;
        
        let gameActive = false;
        let bpm = 140; // ë¶„ë‹¹ ë¹„íŠ¸ ìˆ˜
        let beatInterval = 60000 / bpm; // ë¹„íŠ¸ ê°„ê²© (ë°€ë¦¬ì´ˆ)
        let nextBeatTime = 0;
        let audioContext;
        let beatSound;
        let metronomeInterval;
        let audioPlayer = null;
        let musicFile = null;
        let musicFileName = "";
        let analyser;
        let audioSource;
        let isAnalyzing = false;
        let autoBPM = true;
        
        // DOM ìš”ì†Œ
        const startScreen = document.getElementById('start-screen');
        const resultScreen = document.getElementById('result-screen');
        const wordDisplay = document.getElementById('word-display');
        const currentJamoDisplay = document.getElementById('current-jamo');
        const typedSoFarDisplay = document.getElementById('typed-so-far');
        const scoreDisplay = document.getElementById('score-display');
        const comboDisplay = document.getElementById('combo-display');
        const accuracyDisplay = document.getElementById('accuracy-display');
        const judgmentDisplay = document.getElementById('judgment');
        const startButton = document.getElementById('start-button');
        const restartButton = document.getElementById('restart-button');
        const beatMarker = document.getElementById('beat-marker');
        const beatFlash = document.querySelector('.beat-flash');
        
        // ê°€ìƒ í‚¤ë³´ë“œ í‘œì‹œ
        const virtualKeyboard = document.getElementById('virtual-keyboard');
        if (isMobileDevice()) {
            virtualKeyboard.style.display = 'flex';
        } else {
            virtualKeyboard.style.display = 'none';
        }
        
        // ê°€ìƒ í‚¤ë³´ë“œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        const keys = document.querySelectorAll('.key');
        keys.forEach(key => {
            key.addEventListener('click', function() {
                const jamoKey = this.getAttribute('data-key');
                simulateKeyPress(jamoKey);
                
                // ì‹œê°ì  í”¼ë“œë°±
                this.classList.add('active');
                setTimeout(() => {
                    this.classList.remove('active');
                }, 200);
            });
        });
        
        // ì˜ë¬¸ í‚¤ë³´ë“œ ë§¤í•‘ ì¶”ê°€
        const keyMapping = {
            'q': 'ã…‚', 'w': 'ã…ˆ', 'e': 'ã„·', 'r': 'ã„±', 't': 'ã……', 'y': 'ã…›', 'u': 'ã…•', 'i': 'ã…‘', 'o': 'ã…', 'p': 'ã…”',
            'a': 'ã…', 's': 'ã„´', 'd': 'ã…‡', 'f': 'ã„¹', 'g': 'ã…', 'h': 'ã…—', 'j': 'ã…“', 'k': 'ã…', 'l': 'ã…£',
            'z': 'ã…‹', 'x': 'ã…Œ', 'c': 'ã…Š', 'v': 'ã…', 'b': 'ã… ', 'n': 'ã…œ', 'm': 'ã…¡',
            'Q': 'ã…ƒ', 'W': 'ã…‰', 'E': 'ã„¸', 'R': 'ã„²', 'T': 'ã…†'
        };
        
        // ëª¨ë°”ì¼ ë””ë°”ì´ìŠ¤ ê°ì§€ í•¨ìˆ˜ ì¶”ê°€
        function isMobileDevice() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || window.innerWidth <= 768;
        }
        
        // í‚¤ ëˆ„ë¦„ ì‹œë®¬ë ˆì´ì…˜ - íŒì • ì™„í™”
        function simulateKeyPress(key) {
            if (!gameActive || targetJamoIndex >= decomposedWord.length) return;
            
            totalHits++;
            
            // í˜„ì¬ ì‹œê°„ê³¼ ë‹¤ìŒ ë¹„íŠ¸ ì‹œê°„ì˜ ì°¨ì´ ê³„ì‚°
            const timeDiff = Math.abs((audioContext.currentTime - nextBeatTime + beatInterval / 1000) % (beatInterval / 1000) - (beatInterval / 1000) / 2);
            const accuracyRatio = 1 - (timeDiff / (beatInterval / 1000) * 2);
            
            // ì…ë ¥ íŒì •
            if (key === currentJamo) {
                // ì˜¬ë°”ë¥¸ ìëª¨ ì…ë ¥
                typedSoFar += key;
                typedSoFarDisplay.textContent = typedSoFar;
                targetJamoIndex++;
                correctHits++;
                
                // íƒ€ì´ë°ì— ë”°ë¥¸ ì ìˆ˜ ë° íŒì • - íŒì • ê¸°ì¤€ ì™„í™”
                let judgment = "";
                let points = 0;
                
                if (accuracyRatio > 0.75) {  // 0.9ì—ì„œ 0.75ë¡œ ì™„í™”
                    judgment = "PERFECT";
                    points = 100;
                    combo++;
                    showJudgment(judgment, "perfect");
                } else if (accuracyRatio > 0.5) {  // 0.7ì—ì„œ 0.5ë¡œ ì™„í™”
                    judgment = "GREAT";
                    points = 80;
                    combo++;
                    showJudgment(judgment, "great");
                } else if (accuracyRatio > 0.3) {  // 0.5ì—ì„œ 0.3ìœ¼ë¡œ ì™„í™”
                    judgment = "GOOD";
                    points = 50;
                    combo++;
                    showJudgment(judgment, "good");
                } else {
                    judgment = "BAD";
                    points = 20;
                    // BADì—ì„œë„ ì½¤ë³´ ìœ ì§€ (ì´ì „ì—ëŠ” 0ìœ¼ë¡œ ì´ˆê¸°í™”)
                    combo++; 
                    showJudgment(judgment, "miss");
                }
                
                // ì½¤ë³´ ë³´ë„ˆìŠ¤
                score += points + Math.floor(combo / 10) * 10;
                
                // ì½¤ë³´ íš¨ê³¼
                if (combo > 0 && combo % 10 === 0) {
                    showComboEffect(combo);
                }
                
                // ìµœëŒ€ ì½¤ë³´ ê°±ì‹ 
                if (combo > maxCombo) {
                    maxCombo = combo;
                }
                
                // ë‹¤ìŒ ìëª¨ ì—…ë°ì´íŠ¸
                updateCurrentJamo();
            } else {
                // ì˜ëª»ëœ ì…ë ¥
                showJudgment("MISS", "miss");
                // MISSì¼ ë•Œë§Œ ì½¤ë³´ ë¦¬ì…‹
                combo = 0;
            }
            
            // ì ìˆ˜ ë° ì½¤ë³´ ì—…ë°ì´íŠ¸
            scoreDisplay.textContent = `ì ìˆ˜: ${score}`;
            comboDisplay.textContent = `ì½¤ë³´: ${combo}`;
            
            // ì •í™•ë„ ì—…ë°ì´íŠ¸
            const accuracy = Math.round((correctHits / totalHits) * 100);
            accuracyDisplay.textContent = `ì •í™•ë„: ${accuracy}%`;
        }
        
        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        startButton.addEventListener('click', startGame);
        restartButton.addEventListener('click', resetGame);
        
        // í‚¤ë³´ë“œ ì´ë²¤íŠ¸ ì²˜ë¦¬ ìˆ˜ì •
        document.addEventListener('keydown', function(e) {
            if (!gameActive) return;
            
            const key = e.key;
            
            // í•œê¸€ ìëª¨ ì§ì ‘ ì…ë ¥ ì²˜ë¦¬
            if (isKoreanKey(key)) {
                simulateKeyPress(key);
                return;
            }
            
            // ì˜ë¬¸ í‚¤ë¥¼ í•œê¸€ ìëª¨ë¡œ ë³€í™˜í•˜ì—¬ ì²˜ë¦¬
            if (keyMapping[key]) {
                simulateKeyPress(keyMapping[key]);
                
                // ê°€ìƒ í‚¤ë³´ë“œì—ì„œ í•´ë‹¹ ë²„íŠ¼ ê°•ì¡° í‘œì‹œ
                const keyButtons = document.querySelectorAll('.key');
                keyButtons.forEach(btn => {
                    if (btn.getAttribute('data-key') === keyMapping[key]) {
                        btn.classList.add('active');
                        setTimeout(() => {
                            btn.classList.remove('active');
                        }, 200);
                    }
                });
            }
        });
        
        // ê²Œì„ ì‹œì‘
        function startGame() {
            resetGame();
            startScreen.style.display = 'none';
            gameActive = true;
            
            try {
                // ì˜¤ë””ì˜¤ ì»¨í…ìŠ¤íŠ¸ ì´ˆê¸°í™”
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                // BPM ì„¤ì •
                if (!autoBPM) {
                    const bpmInput = document.getElementById('bpm-input');
                    bpm = parseInt(bpmInput.value, 10) || 140;
                }
                // ì´ë¯¸ ìë™ BPMì´ ê°ì§€ëœ ê²½ìš° ê·¸ ê°’ì„ ì‚¬ìš©
                
                beatInterval = 60000 / bpm;
                
                // ë…¸ë˜ íŒŒì¼ì´ ìˆìœ¼ë©´ ì¬ìƒ
                if (musicFile) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const audioData = e.target.result;
                        
                        // ìŒì•… í”Œë ˆì´ì–´ ì´ˆê¸°í™”
                        if (audioPlayer) {
                            audioPlayer.pause();
                        }
                        
                        audioPlayer = new Audio();
                        audioPlayer.src = audioData;
                        
                        // ìŒì•… ì»¨íŠ¸ë¡¤ í‘œì‹œ
                        const musicControls = document.createElement('div');
                        musicControls.id = 'music-controls';
                        musicControls.innerHTML = `
                            <span class="music-name">ğŸµ ${musicFileName} (BPM: ${bpm})</span>
                        `;
                        document.getElementById('game-container').appendChild(musicControls);
                        
                        // ìŒì•…ê³¼ ê²Œì„ ì‹œì‘
                        audioPlayer.play();
                        startMetronome();
                    };
                    reader.readAsDataURL(musicFile);
                } else {
                    // ë…¸ë˜ íŒŒì¼ ì—†ì´ ì‹œì‘
                    startMetronome();
                }
                
                // ì²« ë²ˆì§¸ ë‹¨ì–´ ì„¤ì •
                setNextWord();
                
                // 60ì´ˆ í›„ ê²Œì„ ì¢…ë£Œ
                setTimeout(endGame, 60000);
            } catch (error) {
                console.error("ê²Œì„ ì‹œì‘ ì˜¤ë¥˜:", error);
                alert("ê²Œì„ ì‹œì‘ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨ í•´ì£¼ì„¸ìš”.");
            }
        }
        
        // ê²Œì„ ë¦¬ì…‹
        function resetGame() {
            score = 0;
            combo = 0;
            maxCombo = 0;
            correctHits = 0;
            totalHits = 0;
            wordsCompleted = 0;
            
            scoreDisplay.textContent = `ì ìˆ˜: ${score}`;
            comboDisplay.textContent = `ì½¤ë³´: ${combo}`;
            accuracyDisplay.textContent = `ì •í™•ë„: 0%`;
            
            wordIndex = 0;
            targetJamoIndex = 0;
            typedSoFar = "";
            
            resultScreen.style.display = 'none';
            
            if (metronomeInterval) {
                clearInterval(metronomeInterval);
            }
            
            // ìŒì•… ì»¨íŠ¸ë¡¤ ì œê±°
            const musicControls = document.getElementById('music-controls');
            if (musicControls) {
                musicControls.remove();
            }
        }
        
        // ë©”íŠ¸ë¡œë†ˆ ì‹œì‘
        function startMetronome() {
            nextBeatTime = audioContext.currentTime;
            
            metronomeInterval = setInterval(() => {
                const currentTime = audioContext.currentTime;
                
                if (currentTime >= nextBeatTime) {
                    playBeat();
                    moveBeatMarker();
                    nextBeatTime += beatInterval / 1000;
                }
            }, 10); // 10ms ê°„ê²©ìœ¼ë¡œ ì²´í¬
        }
        
        // ë¹„íŠ¸ ì†Œë¦¬ ì¬ìƒ
        function playBeat() {
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.type = 'sine';
            oscillator.frequency.value = 880;
            
            gainNode.gain.value = 0.1;
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.start();
            oscillator.stop(audioContext.currentTime + 0.05);
            
            // ì‹œê°ì  íš¨ê³¼
            beatFlash.style.opacity = '1';
            setTimeout(() => {
                beatFlash.style.opacity = '0';
            }, 100);
        }
        
        // ë¹„íŠ¸ ë§ˆì»¤ ì´ë™
        function moveBeatMarker() {
            beatMarker.style.left = '0';
            beatMarker.style.transition = 'none';
            
            setTimeout(() => {
                beatMarker.style.transition = `left ${beatInterval}ms linear`;
                beatMarker.style.left = '100%';
            }, 10);
        }
        
        // ë‹¤ìŒ ë‹¨ì–´ ì„¤ì •
        function setNextWord() {
            currentWord = words[wordIndex % words.length];
            wordDisplay.textContent = currentWord;
            
            // ë‹¨ì–´ë¥¼ ìëª¨ ë‹¨ìœ„ë¡œ ë¶„í•´
            decomposedWord = decomposeWord(currentWord);
            
            targetJamoIndex = 0;
            typedSoFar = "";
            typedSoFarDisplay.textContent = "";
            
            updateCurrentJamo();
        }
        
        // ë‹¨ì–´ë¥¼ ìëª¨ ë‹¨ìœ„ë¡œ ë¶„í•´
        function decomposeWord(word) {
            const result = [];
            
            for (let i = 0; i < word.length; i++) {
                const char = word[i];
                // í•œê¸€ ìœ ë‹ˆì½”ë“œ ë²”ìœ„ í™•ì¸ (ê°€ ~ í£)
                if (char >= 'ê°€' && char <= 'í£') {
                    const charCode = char.charCodeAt(0) - 0xAC00;
                    
                    // ì´ˆì„±, ì¤‘ì„±, ì¢…ì„± ì¶”ì¶œ
                    const jong = charCode % 28;
                    const jung = ((charCode - jong) / 28) % 21;
                    const cho = (((charCode - jong) / 28) - jung) / 21;
                    
                    // ì´ˆì„± (19ê°œ)
                    const choList = ['ã„±', 'ã„²', 'ã„´', 'ã„·', 'ã„¸', 'ã„¹', 'ã…', 'ã…‚', 'ã…ƒ', 'ã……', 'ã…†', 'ã…‡', 'ã…ˆ', 'ã…‰', 'ã…Š', 'ã…‹', 'ã…Œ', 'ã…', 'ã…'];
                    // ì¤‘ì„± (21ê°œ)
                    const jungList = ['ã…', 'ã…', 'ã…‘', 'ã…’', 'ã…“', 'ã…”', 'ã…•', 'ã…–', 'ã…—', 'ã…˜', 'ã…™', 'ã…š', 'ã…›', 'ã…œ', 'ã…', 'ã…', 'ã…Ÿ', 'ã… ', 'ã…¡', 'ã…¢', 'ã…£'];
                    // ì¢…ì„± (28ê°œ, ì²« ë²ˆì§¸ëŠ” ì¢…ì„± ì—†ìŒ)
                    const jongList = ['', 'ã„±', 'ã„²', 'ã„³', 'ã„´', 'ã„µ', 'ã„¶', 'ã„·', 'ã„¹', 'ã„º', 'ã„»', 'ã„¼', 'ã„½', 'ã„¾', 'ã„¿', 'ã…€', 'ã…', 'ã…‚', 'ã…„', 'ã……', 'ã…†', 'ã…‡', 'ã…ˆ', 'ã…Š', 'ã…‹', 'ã…Œ', 'ã…', 'ã…'];
                    
                    // ìëª¨ ì¶”ê°€
                    result.push(choList[cho]);
                    
                    // ë³µí•© ëª¨ìŒì„ ê¸°ë³¸ ëª¨ìŒìœ¼ë¡œ ë¶„í•´
                    const compoundVowels = {
                        'ã…˜': ['ã…—', 'ã…'],
                        'ã…™': ['ã…—', 'ã…'],
                        'ã…š': ['ã…—', 'ã…£'],
                        'ã…': ['ã…œ', 'ã…“'],
                        'ã…': ['ã…œ', 'ã…”'],
                        'ã…Ÿ': ['ã…œ', 'ã…£'],
                        'ã…¢': ['ã…¡', 'ã…£']
                    };
                    
                    const currentJung = jungList[jung];
                    if (compoundVowels[currentJung]) {
                        // ë³µí•© ëª¨ìŒì¸ ê²½ìš° ë¶„í•´í•´ì„œ ì¶”ê°€
                        result.push(...compoundVowels[currentJung]);
                    } else {
                        // ë‹¨ìˆœ ëª¨ìŒì¸ ê²½ìš° ê·¸ëŒ€ë¡œ ì¶”ê°€
                        result.push(currentJung);
                    }
                    
                    // ì¢…ì„±ì´ ìˆëŠ” ê²½ìš° ì¶”ê°€
                    if (jong > 0) {
                        // ë³µí•© ì¢…ì„± ì²˜ë¦¬ (ì˜ˆ: ã„³ = ã„±+ã……)
                        const compoundConsonants = {
                            'ã„³': ['ã„±', 'ã……'],
                            'ã„µ': ['ã„´', 'ã…ˆ'],
                            'ã„¶': ['ã„´', 'ã…'],
                            'ã„º': ['ã„¹', 'ã„±'],
                            'ã„»': ['ã„¹', 'ã…'],
                            'ã„¼': ['ã„¹', 'ã…‚'],
                            'ã„½': ['ã„¹', 'ã……'],
                            'ã„¾': ['ã„¹', 'ã…Œ'],
                            'ã„¿': ['ã„¹', 'ã…'],
                            'ã…€': ['ã„¹', 'ã…'],
                            'ã…„': ['ã…‚', 'ã……']
                        };
                        
                        const currentJong = jongList[jong];
                        if (compoundConsonants[currentJong]) {
                            // ë³µí•© ì¢…ì„±ì¸ ê²½ìš° ë¶„í•´í•´ì„œ ì¶”ê°€
                            result.push(...compoundConsonants[currentJong]);
                        } else {
                            // ë‹¨ìˆœ ì¢…ì„±ì¸ ê²½ìš° ê·¸ëŒ€ë¡œ ì¶”ê°€
                            result.push(currentJong);
                        }
                    }
                } else {
                    // í•œê¸€ì´ ì•„ë‹Œ ê²½ìš° ê·¸ëŒ€ë¡œ ì¶”ê°€
                    result.push(char);
                }
            }
            
            return result;
        }
        
        // í˜„ì¬ ìëª¨ ì—…ë°ì´íŠ¸
        function updateCurrentJamo() {
            if (targetJamoIndex < decomposedWord.length) {
                currentJamo = decomposedWord[targetJamoIndex];
                currentJamoDisplay.textContent = currentJamo;
            } else {
                // ë‹¨ì–´ ì™„ë£Œ
                currentJamoDisplay.textContent = "âœ“";
                wordsCompleted++;
                
                // 0.5ì´ˆ í›„ ë‹¤ìŒ ë‹¨ì–´ë¡œ
                setTimeout(() => {
                    if (gameActive) {
                        wordIndex++;
                        setNextWord();
                    }
                }, 500);
            }
        }
        
        // í•œê¸€ í‚¤ì¸ì§€ í™•ì¸
        function isKoreanKey(key) {
            const koreanKeys = [
                'ã„±', 'ã„²', 'ã„´', 'ã„·', 'ã„¸', 'ã„¹', 'ã…', 'ã…‚', 'ã…ƒ', 'ã……', 'ã…†', 'ã…‡', 'ã…ˆ', 'ã…‰', 'ã…Š', 'ã…‹', 'ã…Œ', 'ã…', 'ã…',
                'ã…', 'ã…', 'ã…‘', 'ã…’', 'ã…“', 'ã…”', 'ã…•', 'ã…–', 'ã…—', 'ã…˜', 'ã…™', 'ã…š', 'ã…›', 'ã…œ', 'ã…', 'ã…', 'ã…Ÿ', 'ã… ', 'ã…¡', 'ã…¢', 'ã…£'
            ];
            return koreanKeys.includes(key);
        }
        
        // íŒì • í‘œì‹œ
        function showJudgment(text, className) {
            judgmentDisplay.textContent = text;
            judgmentDisplay.className = '';
            judgmentDisplay.classList.add(className);
            judgmentDisplay.style.opacity = 1;
            
            setTimeout(() => {
                judgmentDisplay.style.opacity = 0;
            }, 500);
        }
        
        // ì½¤ë³´ íš¨ê³¼ í‘œì‹œ
        function showComboEffect(comboCount) {
            const comboEffect = document.createElement('div');
            comboEffect.className = 'combo-effect';
            comboEffect.textContent = `${comboCount} COMBO!`;
            
            document.getElementById('game-container').appendChild(comboEffect);
            
            // ì• ë‹ˆë©”ì´ì…˜
            setTimeout(() => {
                comboEffect.style.opacity = 1;
                comboEffect.style.transform = 'translate(-50%, -100%) scale(1.5)';
            }, 10);
            
            setTimeout(() => {
                comboEffect.style.opacity = 0;
            }, 1000);
            
            setTimeout(() => {
                comboEffect.remove();
            }, 1500);
        }
        
        // ê²Œì„ ì¢…ë£Œ
        function endGame() {
            gameActive = false;
            clearInterval(metronomeInterval);
            
            // ìŒì•… ì •ì§€
            if (audioPlayer) {
                audioPlayer.pause();
            }
            
            // ê²°ê³¼ í™”ë©´ í‘œì‹œ
            document.getElementById('final-score').textContent = `ìµœì¢… ì ìˆ˜: ${score}`;
            document.getElementById('max-combo').textContent = `ìµœëŒ€ ì½¤ë³´: ${maxCombo}`;
            document.getElementById('final-accuracy').textContent = `ìµœì¢… ì •í™•ë„: ${Math.round((correctHits / totalHits) * 100) || 0}%`;
            document.getElementById('words-completed').textContent = `ì™„ì„±í•œ ë‹¨ì–´: ${wordsCompleted}`;
            resultScreen.style.display = 'flex';
        }
        
        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        document.getElementById('music-file').addEventListener('change', function(e) {
            if (e.target.files.length > 0) {
                musicFile = e.target.files[0];
                musicFileName = musicFile.name;
                
                // ì„ íƒëœ ë…¸ë˜ì—ì„œ BPM ê°ì§€ ì‹œì‘
                if (autoBPM) {
                    detectBPM(musicFile);
                }
            }
        });
        
        // BPM ìë™ ê°ì§€ í† ê¸€ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        document.getElementById('bpm-auto').addEventListener('change', function(e) {
            autoBPM = e.target.checked;
            document.getElementById('manual-bpm-container').style.display = autoBPM ? 'none' : 'flex';
        });
        
        // ì´ˆê¸° ìƒíƒœ ì„¤ì •
        document.getElementById('manual-bpm-container').style.display = 'none';
        
        // BPM ê°ì§€ í•¨ìˆ˜
        function detectBPM(file) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                const audioData = e.target.result;
                
                // AudioContext ìƒì„± (ì•„ì§ ì—†ëŠ” ê²½ìš°)
                if (!audioContext) {
                    try {
                        audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    } catch (error) {
                        console.error("AudioContext ìƒì„± ì˜¤ë¥˜:", error);
                        return;
                    }
                }
                
                // ê°ì§€ ì§„í–‰ ì¤‘ í‘œì‹œ
                document.querySelector('#detected-bpm span').textContent = "ê°ì§€ ì¤‘...";
                
                // ì˜¤ë””ì˜¤ ë””ì½”ë”©
                audioContext.decodeAudioData(audioData, function(buffer) {
                    analyzeBPM(buffer);
                }, function(error) {
                    console.error("ì˜¤ë””ì˜¤ ë””ì½”ë”© ì˜¤ë¥˜:", error);
                    document.querySelector('#detected-bpm span').textContent = "ê°ì§€ ì‹¤íŒ¨";
                });
            };
            
            reader.readAsArrayBuffer(file);
        }
        
        // BPM ë¶„ì„ í•¨ìˆ˜
        function analyzeBPM(audioBuffer) {
            // ì˜¤ë””ì˜¤ ë°ì´í„° ì¶”ì¶œ
            const rawData = audioBuffer.getChannelData(0); // ì²« ë²ˆì§¸ ì±„ë„ ì‚¬ìš©
            const samples = rawData.length;
            const sampleRate = audioBuffer.sampleRate;
            
            // ì—ë„ˆì§€ í”¼í¬ ê°ì§€ë¥¼ ìœ„í•œ ì¤€ë¹„
            const blockSize = Math.floor(sampleRate / 10); // 100ms ë¸”ë¡
            const energies = [];
            const times = [];
            
            // ê° ë¸”ë¡ì˜ ì—ë„ˆì§€ ê³„ì‚°
            for (let i = 0; i < samples - blockSize; i += blockSize) {
                let blockEnergy = 0;
                for (let j = 0; j < blockSize; j++) {
                    blockEnergy += Math.abs(rawData[i + j]);
                }
                energies.push(blockEnergy);
                times.push(i / sampleRate);
            }
            
            // í”¼í¬ ê°ì§€ (ì§€ì—­ ìµœëŒ€ê°’)
            const peaks = [];
            const peakTimes = [];
            const minPeakDistance = 0.2; // ìµœì†Œ í”¼í¬ ê°„ê²© (ì´ˆ)
            const threshold = 0.5; // ì„ê³„ê°’
            
            for (let i = 2; i < energies.length - 2; i++) {
                if (energies[i] > energies[i-1] && 
                    energies[i] > energies[i-2] && 
                    energies[i] > energies[i+1] && 
                    energies[i] > energies[i+2] &&
                    energies[i] > threshold * Math.max(...energies)) {
                    
                    // ë§ˆì§€ë§‰ í”¼í¬ì™€ ì‹œê°„ ì°¨ì´ í™•ì¸
                    const lastPeakTime = peakTimes.length > 0 ? peakTimes[peakTimes.length - 1] : 0;
                    if (times[i] - lastPeakTime >= minPeakDistance) {
                        peaks.push(energies[i]);
                        peakTimes.push(times[i]);
                    }
                }
            }
            
            // í”¼í¬ ê°„ê²© ê³„ì‚°
            const intervals = [];
            for (let i = 1; i < peakTimes.length; i++) {
                intervals.push(peakTimes[i] - peakTimes[i-1]);
            }
            
            // ì¼ê´€ëœ ê°„ê²©ë§Œ í•„í„°ë§
            const validIntervals = intervals.filter(interval => interval > 0.2 && interval < 2.0);
            
            // BPM ê³„ì‚°
            let estimatedBPM = 0;
            if (validIntervals.length > 0) {
                const averageInterval = validIntervals.reduce((a, b) => a + b, 0) / validIntervals.length;
                estimatedBPM = Math.round(60 / averageInterval);
                
                // BPM ë²”ìœ„ ê²€ì¦ (60-200 BPMì´ ì¼ë°˜ì )
                if (estimatedBPM < 60) estimatedBPM *= 2;
                if (estimatedBPM > 200) estimatedBPM = Math.round(estimatedBPM / 2);
            } else {
                // ê¸°ë³¸ê°’ ì„¤ì •
                estimatedBPM = 120;
            }
            
            // BPM í‘œì‹œ
            document.querySelector('#detected-bpm span').textContent = estimatedBPM;
            
            // BPM ì €ì¥
            bpm = estimatedBPM;
            beatInterval = 60000 / bpm;
            
            console.log("ê°ì§€ëœ BPM:", bpm);
        }
    </script>
</body>
</html>